# name: "Deploy Node.js Backend (Theja Astro API)"

# on:
#   push:
#     branches:
#       - main

# jobs:
#   test-and-lint:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repo
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#           cache: "npm" # Speeds up repeated runs

#       - name: Install Dependencies
#         run: npm ci

#       - name: Run Tests
#         run: npm test # Will fail job if tests fail

#   deploy:
#     needs: test-and-lint # Only run if tests/lint pass
#     runs-on: ubuntu-latest
#     environment: production # Optional: for GitHub Environments approval

#     steps:
#       - name: Deploy to VPS
#         uses: appleboy/ssh-action@v1
#         with:
#           host: ${{ secrets.VPS_HOST }}
#           username: ${{ secrets.VPS_USERS }}
#           key: ${{ secrets.VPS_SSH_KEY }}
#           script: |
#             cd ${{ secrets.VPS_PATH_NAME }}
#             git pull origin main
#             npm ci --production  # Only prod deps on server
#             pm2 reload thejaastro --update-env  # Zero-downtime reload (better than restart)




name: Deploy Theja Astro Backend

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERS }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "===== CONNECTED TO VPS ====="
            whoami
            node -v
            pm2 -v

            cd ${{ secrets.VPS_PATH_NAME }}

            echo "===== CURRENT COMMIT ====="
            git log -1 --oneline

            echo "===== PULLING LATEST CODE ====="
            git fetch origin
            git reset --hard origin/main

            echo "===== NEW COMMIT ====="
            git log -1 --oneline

            echo "===== INSTALLING DEPENDENCIES ====="
            npm ci

            # If you have build step (TS/Nest/Astro backend)
            # npm run build

            echo "===== PM2 STATUS BEFORE ====="
            pm2 list

            echo "===== RELOADING APPLICATION ====="
            pm2 reload thejaastro --update-env

            echo "===== SAVING PM2 STATE ====="
            pm2 save

            echo "===== PM2 STATUS AFTER ====="
            pm2 list

            echo "===== LAST LOGS ====="
            pm2 logs thejaastro --lines 20 --nostream

            echo "===== DEPLOYMENT SUCCESS ====="