# name: "Deploy Node.js Backend (Theja Astro API)"

# on:
#   push:
#     branches:
#       - main

# jobs:
#   test-and-lint:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout Repo
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: "20"
#           cache: "npm" # Speeds up repeated runs

#       - name: Install Dependencies
#         run: npm ci

#       - name: Run Tests
#         run: npm test # Will fail job if tests fail

#   deploy:
#     needs: test-and-lint # Only run if tests/lint pass
#     runs-on: ubuntu-latest
#     environment: production # Optional: for GitHub Environments approval

#     steps:
#       - name: Deploy to VPS
#         uses: appleboy/ssh-action@v1
#         with:
#           host: ${{ secrets.VPS_HOST }}
#           username: ${{ secrets.VPS_USERS }}
#           key: ${{ secrets.VPS_SSH_KEY }}
#           script: |
#             cd ${{ secrets.VPS_PATH_NAME }}
#             git pull origin main
#             npm ci --production  # Only prod deps on server
#             pm2 reload thejaastro --update-env  # Zero-downtime reload (better than restart)






name: "Deploy Theja Astro backend on VPS"

on:
  push:
    branches:
      - main

jobs:
  test-and-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm" # Speeds up repeated runs

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test # Will fail job if tests fail

  deploy:
    needs: test-and-lint # Only run if tests/lint pass
    runs-on: ubuntu-latest
    environment: production # Optional: for GitHub Environments approval
    
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1
      with:
        host: ${{secrets.VPS_HOST}} 
        username: ${{secrets.VPS_USERS}}
        key: ${{secrets.VPS_SSH_KEY}}
        scripts: |
          cd ${{secrets.VPS_PATH_NAME}}
          git pull origin main
          npm ci
          pm2 reload thejaastro